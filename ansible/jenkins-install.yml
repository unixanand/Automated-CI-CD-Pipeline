---
- name: Configure fully automated Jenkins with GitHub webhook
  hosts: jenkins
  become: yes

  vars:
    jenkins_home: /var/lib/jenkins
    github_repo_owner: unixanand
    github_repo_name: Automated-CI-CD-Pipeline
    github_token: "{{ lookup('env', 'GITHUB_TOKEN') }}"
    ec2_public_ip: "{{ ansible_host }}"

  handlers:
    - name: restart jenkins
      systemd:
        name: jenkins
        state: restarted
        enabled: yes

  tasks:

    # -----------------------------
    # Install minimal required packages
    # -----------------------------
    - name: Install required packages
      apt:
        name:
          - git
          - unzip
        update_cache: yes
        state: present

    # -----------------------------
    # Wait until Jenkins is initialized
    # -----------------------------
    - name: Wait for Jenkins home directory
      wait_for:
        path: "{{ jenkins_home }}"
        timeout: 300

    # -----------------------------
    # Ensure Jenkins user can use Docker
    # -----------------------------
    - name: Add Jenkins to docker group
      user:
        name: jenkins
        groups: docker
        append: yes
      notify: restart jenkins

    # -----------------------------
    # Disable Jenkins setup wizard (correct systemd method)
    # -----------------------------
    - name: Create systemd override directory
      file:
        path: /etc/systemd/system/jenkins.service.d
        state: directory

    - name: Disable setup wizard
      copy:
        dest: /etc/systemd/system/jenkins.service.d/override.conf
        content: |
          [Service]
          Environment="JAVA_ARGS=-Djenkins.install.runSetupWizard=false"
      notify: restart jenkins

    - name: Reload systemd daemon
      command: systemctl daemon-reexec

    # -----------------------------
    # Install Jenkins plugins (including JCasC)
    # -----------------------------
    - name: Copy plugins list
      copy:
        src: files/plugins.txt
        dest: /tmp/plugins.txt

    - name: Install Jenkins plugins
      shell: /usr/bin/jenkins-plugin-cli --plugin-file /tmp/plugins.txt
      environment:
        JENKINS_HOME: "{{ jenkins_home }}"
      notify: restart jenkins

    # -----------------------------
    # Apply Jenkins Configuration as Code (JCasC)
    # -----------------------------
    - name: Create JCasC directory
      file:
        path: "{{ jenkins_home }}/casc_configs"
        state: directory
        owner: jenkins
        group: jenkins
        mode: "0755"

    - name: Copy JCasC config
      copy:
        src: files/jenkins.yaml
        dest: "{{ jenkins_home }}/casc_configs/jenkins.yaml"
        owner: jenkins
        group: jenkins
        mode: "0644"
      notify: restart jenkins

    - name: Enable JCasC via systemd environment
      copy:
        dest: /etc/systemd/system/jenkins.service.d/casc.conf
        content: |
          [Service]
          Environment="CASC_JENKINS_CONFIG={{ jenkins_home }}/casc_configs"
      notify: restart jenkins

    - name: Reload systemd after JCasC config
      command: systemctl daemon-reexec

    # -----------------------------
    # Ensure Jenkins running with config
    # -----------------------------
    - name: Ensure Jenkins service started
      systemd:
        name: jenkins
        state: started
        enabled: yes

    # -----------------------------
    # Wait for Jenkins to be ready
    # -----------------------------
    - name: Wait for Jenkins API
      uri:
        url: http://localhost:8080/login
        status_code: 200
      register: result
      until: result.status == 200
      retries: 30
      delay: 10

    # -----------------------------
    # Automatically create GitHub webhook
    # -----------------------------
    - name: Create GitHub webhook
      uri:
        url: "https://api.github.com/repos/{{ github_repo_owner }}/{{ github_repo_name }}/hooks"
        method: POST
        headers:
          Authorization: "token {{ github_token }}"
          Accept: "application/vnd.github+json"
        body_format: json
        body:
          name: web
          active: true
          events:
            - push
          config:
            url: "http://{{ ec2_public_ip }}:8080/github-webhook/"
            content_type: json
        status_code: [201, 422]
