- name: Configure fully automated Jenkins with GitHub webhook
  hosts: jenkins
  become: yes

  vars:
    jenkins_home: /var/lib/jenkins
    github_repo_owner: unixanand
    github_repo_name: Automated-CI-CD-Pipeline
    github_token: "{{ lookup('env', 'GITHUB_TOKEN') | default('', true) }}"
    ec2_public_ip: "{{ ansible_host }}"

  handlers:
    - name: restart jenkins
      systemd:
        name: jenkins
        state: restarted
        enabled: yes

  tasks:

    # Install base tools
    - name: Install required packages
      apt:
        name:
          - git
          - unzip
        update_cache: yes
        state: present

    # Wait until Jenkins initialized
    - name: Wait for Jenkins home directory
      wait_for:
        path: "{{ jenkins_home }}"
        timeout: 300

    # Allow Jenkins to use Docker
    - name: Add Jenkins to docker group
      user:
        name: jenkins
        groups: docker
        append: yes
      notify: restart jenkins

    # Systemd override directory
    - name: Create systemd override directory
      file:
        path: /etc/systemd/system/jenkins.service.d
        state: directory

    # Disable setup wizard
    - name: Disable Jenkins setup wizard
      copy:
        dest: /etc/systemd/system/jenkins.service.d/override.conf
        content: |
          [Service]
          Environment="JAVA_ARGS=-Djenkins.install.runSetupWizard=false"
      notify: restart jenkins

    # Export Jenkins URL
    - name: Set Jenkins URL
      copy:
        dest: /etc/systemd/system/jenkins.service.d/env.conf
        content: |
          [Service]
          Environment="JENKINS_URL=http://{{ ec2_public_ip }}:8080"
      notify: restart jenkins

    - name: Reload systemd daemon
      command: systemctl daemon-reload

    # Install plugins
    - name: Copy plugins list
      copy:
        src: files/plugins.txt
        dest: /tmp/plugins.txt

    - name: Install Jenkins plugins
      shell: /usr/bin/jenkins-plugin-cli --plugin-file /tmp/plugins.txt
      environment:
        JENKINS_HOME: "{{ jenkins_home }}"
      notify: restart jenkins

    - name: Fix plugin ownership
      file:
        path: "{{ jenkins_home }}/plugins"
        owner: jenkins
        group: jenkins
        recurse: yes

    # Apply JCasC
    - name: Create JCasC directory
      file:
        path: "{{ jenkins_home }}/casc_configs"
        state: directory
        owner: jenkins
        group: jenkins

    - name: Copy Jenkins JCasC config
      copy:
        src: files/jenkins.yaml
        dest: "{{ jenkins_home }}/casc_configs/jenkins.yaml"
        owner: jenkins
        group: jenkins
      notify: restart jenkins

    - name: Copy Job DSL script
      copy:
        src: files/job.groovy
        dest: "{{ jenkins_home }}/job.groovy"
        owner: jenkins
        group: jenkins
      notify: restart jenkins

    - name: Enable JCasC
      copy:
        dest: /etc/systemd/system/jenkins.service.d/casc.conf
        content: |
          [Service]
          Environment="CASC_JENKINS_CONFIG={{ jenkins_home }}/casc_configs"
      notify: restart jenkins

    - name: Reload systemd after JCasC
      command: systemctl daemon-reload

    # Ensure Jenkins running
    - name: Ensure Jenkins service started
      systemd:
        name: jenkins
        state: started
        enabled: yes

    # Wait for Jenkins ready
    - name: Wait for Jenkins API
      uri:
        url: http://localhost:8080/login
        status_code: 200
      register: result
      until: result.status == 200
      retries: 30
      delay: 10

    # Create GitHub webhook if token provided
    - name: Create GitHub webhook
      uri:
        url: "https://api.github.com/repos/{{ github_repo_owner }}/{{ github_repo_name }}/hooks"
        method: POST
        headers:
          Authorization: "token {{ github_token }}"
          Accept: "application/vnd.github+json"
        body_format: json
        body:
          name: web
          active: true
          events:
            - push
          config:
            url: "http://{{ ec2_public_ip }}:8080/github-webhook/"
            content_type: json
        status_code: [201, 422]
      when: github_token != ""